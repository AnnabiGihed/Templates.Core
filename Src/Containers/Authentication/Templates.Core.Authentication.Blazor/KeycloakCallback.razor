@page "/auth/callback"
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.WebUtilities
@using Templates.Core.Authentication.Blazor.Services
@inject IBlazorKeycloakAuthService Auth
@inject NavigationManager Nav

@*
    Author      : Gihed Annabi
    Date        : 02-2026
    Purpose     : Handles the Keycloak Authorization Code + PKCE redirect callback.
                  Keycloak redirects here with ?code=...&state=... after the user
                  authenticates. This page exchanges the code for tokens via
                  IBlazorKeycloakAuthService.HandleCallbackAsync — all token material
                  is stored server-side in Redis; nothing sensitive is written to the browser.

    Keycloak client configuration:
        Valid Redirect URIs: https://<your-app>/auth/callback
*@

<div style="display:flex; justify-content:center; align-items:center; height:100vh">
    @if (_error is not null)
    {
        <div>
            <p style="color:red">Authentication failed: @_error</p>
            <a href="/">Return to home</a>
        </div>
    }
    else
    {
        <p>Signing you in…</p>
    }
</div>

@code {
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        // Keycloak error response
        if (query.TryGetValue("error", out var err))
        {
            var desc = query.TryGetValue("error_description", out var d) ? $": {d}" : string.Empty;
            _error = $"{err}{desc}";
            return;
        }

        if (!query.TryGetValue("code", out var code) ||
            !query.TryGetValue("state", out var state))
        {
            _error = "Missing code or state parameter.";
            return;
        }

        var success = await Auth.HandleCallbackAsync(code!, state!);

        if (!success)
        {
            _error = "Token exchange failed. Please try logging in again.";
            return;
        }

        // Navigate to the return URL saved before the redirect (stored in Redis session)
        Nav.NavigateTo("/", replace: true);
    }
}
